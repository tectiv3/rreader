import{y as P,a as c,E as x,s as _}from"./app-CZSjId66.js";import{u as h}from"./useSidebarStore-CT2MGwMZ.js";const q=P("articles",()=>{const n=c([]),u=c(new Map),p=new Map,d=c({type:"all"}),C=c(!1),v=c(!1),g=c("All Feeds"),o=c(!1),i=c(null),m=c(!1),I=new Map,S=20,M=x(()=>n.value.filter(e=>!e.is_read).length),U=x(()=>n.value.filter(e=>e.is_read_later).length),R=x(()=>{const e={};for(const t of n.value)t.is_read||(e[t.feed_id]=(e[t.feed_id]||0)+1);return e});function A(e){return u.value.get(e)||null}function T(e){const t=n.value.findIndex(a=>a.id===e);return t===-1?{prev:null,next:null}:{prev:t>0?n.value[t-1].id:null,next:t<n.value.length-1?n.value[t+1].id:null}}function j(e){return e.feedId?`feed:${e.feedId}`:e.categoryId?`category:${e.categoryId}`:e.type}function k(){if(!v.value||n.value.length===0)return;const e=j(d.value);I.set(e,{articles:n.value,filterTitle:g.value,hasMore:o.value,nextCursor:i.value})}async function F(e){if(v.value&&d.value.type===e.type&&d.value.feedId===e.feedId&&d.value.categoryId===e.categoryId)return;k();const t=j(e),a=I.get(t);if(a){n.value=a.articles,g.value=a.filterTitle,o.value=a.hasMore,i.value=a.nextCursor,d.value=e,v.value=!0;return}C.value=!0,n.value=[],d.value=e,i.value=null,o.value=!1;const r=new URLSearchParams;e.feedId&&r.set("feed_id",e.feedId),e.categoryId&&r.set("category_id",e.categoryId),e.type==="today"&&r.set("filter","today"),e.type==="read_later"&&r.set("filter","read_later"),e.type==="recently_read"&&r.set("filter","recently_read");try{const s=await _.get("/api/articles?"+r.toString());n.value=s.data.articles,g.value=s.data.filter_title,o.value=s.data.has_more,i.value=s.data.next_cursor,v.value=!0}finally{C.value=!1}}async function D(){if(!(!o.value||m.value||!i.value)){m.value=!0;try{const e=new URLSearchParams;d.value.feedId&&e.set("feed_id",d.value.feedId),d.value.categoryId&&e.set("category_id",d.value.categoryId),d.value.type==="today"&&e.set("filter","today"),d.value.type==="read_later"&&e.set("filter","read_later"),d.value.type==="recently_read"&&e.set("filter","recently_read"),e.set("cursor",i.value);const t=await _.get("/api/articles?"+e.toString());n.value=[...n.value,...t.data.articles],o.value=t.data.has_more,i.value=t.data.next_cursor}finally{m.value=!1}}}async function b(e){const t=u.value.get(e);if(t)return u.value.delete(e),u.value.set(e,t),t;if(p.has(e))return p.get(e);const a=_.get(`/api/articles/${e}`).then(r=>{const s=r.data;if(u.value.set(e,s),u.value.size>S){const l=u.value.keys().next().value;u.value.delete(l)}return p.delete(e),s}).catch(r=>{throw p.delete(e),r});return p.set(e,a),a}function $(e){const{prev:t,next:a}=T(e);a&&b(a).catch(()=>{}),t&&b(t).catch(()=>{})}function y(e){const t=new Date(e),a=new Date;return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()}function E(e){const t=n.value.find(r=>r.id===e);if(!t||t.is_read)return;t.is_read=!0,t.read_at=new Date().toISOString();const a=h();a.decrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(-1),_.patch(`/api/articles/${e}`,{is_read:!0}).catch(()=>{t.is_read=!1,t.read_at=null,a.incrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(1)})}function L(e){const t=n.value.find(r=>r.id===e);if(!t||!t.is_read)return;t.is_read=!1,t.read_at=null;const a=h();a.incrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(1),_.patch(`/api/articles/${e}`,{is_read:!1}).catch(()=>{t.is_read=!0,a.decrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(-1)})}function O(e){const t=n.value.find(s=>s.id===e);if(!t)return;const a=t.is_read_later;t.is_read_later=!a;const r=h();r.adjustReadLaterCount(a?-1:1),_.patch(`/api/articles/${e}`,{is_read_later:!a}).catch(()=>{t.is_read_later=a,r.adjustReadLaterCount(a?1:-1)})}function N(e=null){const t=e?n.value.filter(l=>l.feed_id===e&&!l.is_read):n.value.filter(l=>!l.is_read),a={};let r=0;t.forEach(l=>{a[l.feed_id]=(a[l.feed_id]||0)+1,y(l.published_at)&&r++}),t.forEach(l=>{l.is_read=!0,l.read_at=new Date().toISOString()});const s=h();for(const[l,f]of Object.entries(a))s.decrementFeedUnread(Number(l),f);r&&s.adjustTodayCount(-r),_.post("/api/articles/mark-all-read",{feed_id:d.value.feedId||null,category_id:d.value.categoryId||null,filter:["today","read_later"].includes(d.value.type)?d.value.type:null}).catch(()=>{t.forEach(l=>{l.is_read=!1,l.read_at=null});for(const[l,f]of Object.entries(a))s.incrementFeedUnread(Number(l),f);r&&s.adjustTodayCount(r)})}function w(e){const t=n.value.findIndex(f=>f.id===e);if(t===-1)return;const a=n.value[t],r=!a.is_read,s=a.feed_id,l=y(a.published_at);if(n.value.splice(t,1),r){const f=h();f.decrementFeedUnread(s),l&&f.adjustTodayCount(-1),_.patch(`/api/articles/${e}`,{is_read:!0}).catch(()=>{})}}function K(){return I.clear(),v.value=!1,i.value=null,o.value=!1,F(d.value)}return{articles:n,contentCache:u,activeView:d,loading:C,loaded:v,filterTitle:g,hasMore:o,loadingMore:m,nextCursor:i,unreadCount:M,readLaterCount:U,unreadByFeed:R,getContent:A,adjacentIds:T,fetchArticles:F,loadMore:D,fetchContent:b,prefetchAdjacent:$,markRead:E,markUnread:L,toggleReadLater:O,markAllRead:N,dismissArticle:w,forceRefresh:K}});export{q as u};
