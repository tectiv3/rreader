import{y as $,a as i,E as I,s as o}from"./app-BC67mUnF.js";import{u as p}from"./useSidebarStore-BPI83-rn.js";const Y=$("articles",()=>{const n=i([]),u=i(new Map),y=new Map,d=i({type:"all"}),m=i(!1),h=i(!1),b=i("All Feeds"),_=i(!1),f=i(null),g=i(!1),F=20,S=I(()=>n.value.filter(t=>!t.is_read).length),T=I(()=>n.value.filter(t=>t.is_read_later).length),U=I(()=>{const t={};for(const e of n.value)e.is_read||(t[e.feed_id]=(t[e.feed_id]||0)+1);return t});function R(t){return u.value.get(t)??null}function j(t){const e=n.value.findIndex(a=>a.id===t);return e===-1?{prev:null,next:null}:{prev:e>0?n.value[e-1].id:null,next:e<n.value.length-1?n.value[e+1].id:null}}async function x(t){if(h.value&&d.value.type===t.type&&d.value.feedId===t.feedId&&d.value.categoryId===t.categoryId)return;m.value=!0,d.value=t,f.value=null,_.value=!1;const e=new URLSearchParams;t.feedId&&e.set("feed_id",t.feedId),t.categoryId&&e.set("category_id",t.categoryId),t.type==="today"&&e.set("filter","today"),t.type==="read_later"&&e.set("filter","read_later"),t.type==="recently_read"&&e.set("filter","recently_read");try{const a=await o.get("/api/articles?"+e.toString());n.value=a.data.articles,b.value=a.data.filter_title,_.value=a.data.has_more,f.value=a.data.next_cursor,h.value=!0}finally{m.value=!1}}async function A(){if(!(!_.value||g.value||!f.value)){g.value=!0;try{const t=new URLSearchParams;d.value.feedId&&t.set("feed_id",d.value.feedId),d.value.categoryId&&t.set("category_id",d.value.categoryId),d.value.type==="today"&&t.set("filter","today"),d.value.type==="read_later"&&t.set("filter","read_later"),d.value.type==="recently_read"&&t.set("filter","recently_read"),t.set("cursor",f.value);const e=await o.get("/api/articles?"+t.toString());n.value=[...n.value,...e.data.articles],_.value=e.data.has_more,f.value=e.data.next_cursor}finally{g.value=!1}}}async function C(t){const e=u.value.get(t);if(e)return u.value.delete(t),u.value.set(t,e),e;if(y.has(t))return y.get(t);const a=o.get(`/api/articles/${t}`).then(l=>{const s=l.data;if(u.value.set(t,s),u.value.size>F){const r=u.value.keys().next().value;u.value.delete(r)}return y.delete(t),s}).catch(l=>{throw y.delete(t),l});return y.set(t,a),a}function M(t){const{prev:e,next:a}=j(t);a&&C(a).catch(()=>{}),e&&C(e).catch(()=>{})}function v(t){const e=new Date(t),a=new Date;return e.getFullYear()===a.getFullYear()&&e.getMonth()===a.getMonth()&&e.getDate()===a.getDate()}function D(t){const e=n.value.find(l=>l.id===t);if(!e||e.is_read)return;e.is_read=!0,e.read_at=new Date().toISOString();const a=p();a.decrementFeedUnread(e.feed_id),v(e.published_at)&&a.adjustTodayCount(-1),o.patch(`/api/articles/${t}`,{is_read:!0}).catch(()=>{e.is_read=!1,e.read_at=null,a.incrementFeedUnread(e.feed_id),v(e.published_at)&&a.adjustTodayCount(1)})}function E(t){const e=n.value.find(l=>l.id===t);if(!e||!e.is_read)return;e.is_read=!1,e.read_at=null;const a=p();a.incrementFeedUnread(e.feed_id),v(e.published_at)&&a.adjustTodayCount(1),o.patch(`/api/articles/${t}`,{is_read:!1}).catch(()=>{e.is_read=!0,a.decrementFeedUnread(e.feed_id),v(e.published_at)&&a.adjustTodayCount(-1)})}function L(t){const e=n.value.find(s=>s.id===t);if(!e)return;const a=e.is_read_later;e.is_read_later=!a;const l=p();l.adjustReadLaterCount(a?-1:1),o.patch(`/api/articles/${t}`,{is_read_later:!a}).catch(()=>{e.is_read_later=a,l.adjustReadLaterCount(a?1:-1)})}function k(t=null){const e=t?n.value.filter(r=>r.feed_id===t&&!r.is_read):n.value.filter(r=>!r.is_read),a={};let l=0;e.forEach(r=>{a[r.feed_id]=(a[r.feed_id]||0)+1,v(r.published_at)&&l++}),e.forEach(r=>{r.is_read=!0,r.read_at=new Date().toISOString()});const s=p();for(const[r,c]of Object.entries(a))s.decrementFeedUnread(Number(r),c);l&&s.adjustTodayCount(-l),o.post("/api/articles/mark-all-read",{feed_id:d.value.feedId??null,category_id:d.value.categoryId??null,filter:["today","read_later"].includes(d.value.type)?d.value.type:null}).catch(()=>{e.forEach(r=>{r.is_read=!1,r.read_at=null});for(const[r,c]of Object.entries(a))s.incrementFeedUnread(Number(r),c);l&&s.adjustTodayCount(l)})}function w(t){const e=n.value.findIndex(c=>c.id===t);if(e===-1)return;const a=n.value[e],l=!a.is_read,s=a.feed_id,r=v(a.published_at);if(n.value.splice(e,1),l){const c=p();c.decrementFeedUnread(s),r&&c.adjustTodayCount(-1),o.patch(`/api/articles/${t}`,{is_read:!0}).catch(()=>{})}}function O(){return h.value=!1,f.value=null,_.value=!1,x(d.value)}return{articles:n,contentCache:u,activeView:d,loading:m,loaded:h,filterTitle:b,hasMore:_,loadingMore:g,nextCursor:f,unreadCount:S,readLaterCount:T,unreadByFeed:U,getContent:R,adjacentIds:j,fetchArticles:x,loadMore:A,fetchContent:C,prefetchAdjacent:M,markRead:D,markUnread:E,toggleReadLater:L,markAllRead:k,dismissArticle:w,forceRefresh:O}});export{Y as u};
