import{y as V,a as o,E as x,s as f}from"./app-ClRdnNOD.js";import{u as m}from"./useSidebarStore-ysoHxPmv.js";const z=V("articles",()=>{const r=o([]),c=o(new Map),p=new Map,s=o({type:"all"}),h=o(!1),_=o(!1),g=o("All Feeds"),i=o(!1),d=o(null),I=o(!1),C=new Map,F=20,U=x(()=>r.value.filter(e=>!e.is_read).length),M=x(()=>r.value.filter(e=>e.is_read_later).length),A=x(()=>{const e={};for(const t of r.value)t.is_read||(e[t.feed_id]=(e[t.feed_id]||0)+1);return e});function R(e){return c.value.get(e)||null}function T(e){const t=r.value.findIndex(a=>a.id===e);return t===-1?{prev:null,next:null}:{prev:t>0?r.value[t-1].id:null,next:t<r.value.length-1?r.value[t+1].id:null}}function S(e){return e.feedId?`feed:${e.feedId}`:e.categoryId?`category:${e.categoryId}`:e.type}function w(){if(!_.value||r.value.length===0)return;const e=S(s.value);C.set(e,{articles:r.value,filterTitle:g.value,hasMore:i.value,nextCursor:d.value})}async function j(e){if(_.value&&s.value.type===e.type&&s.value.feedId===e.feedId&&s.value.categoryId===e.categoryId)return;w();const t=S(e),a=C.get(t);if(a){r.value=a.articles,g.value=a.filterTitle,i.value=a.hasMore,d.value=a.nextCursor,s.value=e,_.value=!0;return}h.value=!0,r.value=[],s.value=e,d.value=null,i.value=!1;const l=new URLSearchParams;e.feedId&&l.set("feed_id",e.feedId),e.categoryId&&l.set("category_id",e.categoryId),e.type==="today"&&l.set("filter","today"),e.type==="read_later"&&l.set("filter","read_later"),e.type==="recently_read"&&l.set("filter","recently_read");try{const u=await f.get("/api/articles?"+l.toString());r.value=u.data.articles,g.value=u.data.filter_title,i.value=u.data.has_more,d.value=u.data.next_cursor,_.value=!0}finally{h.value=!1}}async function k(){const e=s.value;if(!e.feedId)return;h.value=!0,r.value=[],d.value=null,i.value=!1;const t=new URLSearchParams;t.set("feed_id",e.feedId),t.set("show_all","1");try{const a=await f.get("/api/articles?"+t.toString());r.value=a.data.articles,g.value=a.data.filter_title,i.value=a.data.has_more,d.value=a.data.next_cursor,_.value=!0}finally{h.value=!1}}async function D(){if(!(!i.value||I.value||!d.value)){I.value=!0;try{const e=new URLSearchParams;s.value.feedId&&e.set("feed_id",s.value.feedId),s.value.categoryId&&e.set("category_id",s.value.categoryId),s.value.type==="today"&&e.set("filter","today"),s.value.type==="read_later"&&e.set("filter","read_later"),s.value.type==="recently_read"&&e.set("filter","recently_read"),e.set("cursor",d.value);const t=await f.get("/api/articles?"+e.toString());r.value=[...r.value,...t.data.articles],i.value=t.data.has_more,d.value=t.data.next_cursor}finally{I.value=!1}}}async function b(e){const t=c.value.get(e);if(t)return c.value.delete(e),c.value.set(e,t),t;if(p.has(e))return p.get(e);const a=f.get(`/api/articles/${e}`).then(l=>{const u=l.data;if(c.value.set(e,u),c.value.size>F){const n=c.value.keys().next().value;c.value.delete(n)}return p.delete(e),u}).catch(l=>{throw p.delete(e),l});return p.set(e,a),a}function L(e){const{prev:t,next:a}=T(e);a&&b(a).catch(()=>{}),t&&b(t).catch(()=>{})}function y(e){const t=new Date(e),a=new Date;return t.getFullYear()===a.getFullYear()&&t.getMonth()===a.getMonth()&&t.getDate()===a.getDate()}function $(e){const t=r.value.find(l=>l.id===e);if(!t||t.is_read)return;t.is_read=!0,t.read_at=new Date().toISOString();const a=m();a.decrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(-1),f.patch(`/api/articles/${e}`,{is_read:!0}).catch(()=>{t.is_read=!1,t.read_at=null,a.incrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(1)})}function E(e){const t=r.value.find(l=>l.id===e);if(!t||!t.is_read)return;t.is_read=!1,t.read_at=null;const a=m();a.incrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(1),f.patch(`/api/articles/${e}`,{is_read:!1}).catch(()=>{t.is_read=!0,a.decrementFeedUnread(t.feed_id),y(t.published_at)&&a.adjustTodayCount(-1)})}function O(e){const t=r.value.find(u=>u.id===e);if(!t)return;const a=t.is_read_later;t.is_read_later=!a;const l=m();l.adjustReadLaterCount(a?-1:1),f.patch(`/api/articles/${e}`,{is_read_later:!a}).catch(()=>{t.is_read_later=a,l.adjustReadLaterCount(a?1:-1)})}function N(e=null){const t=e?r.value.filter(n=>n.feed_id===e&&!n.is_read):r.value.filter(n=>!n.is_read),a={};let l=0;t.forEach(n=>{a[n.feed_id]=(a[n.feed_id]||0)+1,y(n.published_at)&&l++}),t.forEach(n=>{n.is_read=!0,n.read_at=new Date().toISOString()});const u=m();for(const[n,v]of Object.entries(a))u.decrementFeedUnread(Number(n),v);l&&u.adjustTodayCount(-l),f.post("/api/articles/mark-all-read",{feed_id:s.value.feedId||null,category_id:s.value.categoryId||null,filter:["today","read_later"].includes(s.value.type)?s.value.type:null}).catch(()=>{t.forEach(n=>{n.is_read=!1,n.read_at=null});for(const[n,v]of Object.entries(a))u.incrementFeedUnread(Number(n),v);l&&u.adjustTodayCount(l)})}function P(e){const t=r.value.findIndex(v=>v.id===e);if(t===-1)return;const a=r.value[t],l=!a.is_read,u=a.feed_id,n=y(a.published_at);if(r.value.splice(t,1),l){const v=m();v.decrementFeedUnread(u),n&&v.adjustTodayCount(-1),f.patch(`/api/articles/${e}`,{is_read:!0}).catch(()=>{})}}function K(){return C.clear(),_.value=!1,d.value=null,i.value=!1,j(s.value)}return{articles:r,contentCache:c,activeView:s,loading:h,loaded:_,filterTitle:g,hasMore:i,loadingMore:I,nextCursor:d,unreadCount:U,readLaterCount:M,unreadByFeed:A,getContent:R,adjacentIds:T,fetchArticles:j,showAllFeedArticles:k,loadMore:D,fetchContent:b,prefetchAdjacent:L,markRead:$,markUnread:E,toggleReadLater:O,markAllRead:N,dismissArticle:P,forceRefresh:K}});export{z as u};
